<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SQLite Database Viewer</title>
    <script src="https://sql.js.org/dist/sql-wasm.js"></script>
  </head>
  <body>
    <h1>SQLite Database Viewer</h1>
    <div id="output"></div>
    <script>
      initSqlJs({
        locateFile: (file) => `https://sql.js.org/dist/${file}`,
      }).then((SQL) => {
        fetch("/api/db-viewer/db")
          .then(async (response) => {
            if (!response.ok) {
              const status = response.status;
              const text = await response.text().catch(() => null);
              const safeMsg =
                `Failed to download database (HTTP ${status}).` +
                (text ? ` Server message: ${text}` : "");
              document.getElementById("output").innerText = safeMsg;
              throw new Error(safeMsg);
            }
            return response.arrayBuffer();
          })
          .then((buffer) => {
            const db = new SQL.Database(new Uint8Array(buffer));
            const tables = db.exec(
              "SELECT name FROM sqlite_master WHERE type='table'"
            );
            const output = document.getElementById("output");
            tables[0].values.forEach((table) => {
              const tableName = table[0];
              const result = db.exec(`SELECT * FROM ${tableName}`);
              output.innerHTML += `<h2>${tableName}</h2>`;
              if (result.length > 0) {
                const columns = result[0].columns;
                const values = result[0].values;
                let tableHtml = '<table border="1"><thead><tr>';
                columns.forEach((col) => {
                  tableHtml += `<th>${col}</th>`;
                });
                tableHtml += "</tr></thead><tbody>";
                values.forEach((row) => {
                  tableHtml += "<tr>";
                  row.forEach((cell) => {
                    tableHtml += `<td>${cell}</td>`;
                  });
                  tableHtml += "</tr>";
                });
                tableHtml += "</tbody></table>";
                output.innerHTML += tableHtml;
              }
            });
          })
          .catch((err) => {
            // Error already shown above; avoid leaking any internal variable names.
            console.error(err);
          });
      });
    </script>
  </body>
</html>
